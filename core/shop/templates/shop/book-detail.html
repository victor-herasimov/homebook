{% extends "base.html" %}
{% load static %}

{% block styles %}
        {% include "components/_styles.html" %}
        <link rel="stylesheet" href="{% static "css/starrating.css" %}">
{% endblock styles %}

{% block content %}
    <div class="container my-4">
        <div class="row">
            <!-- Book Image -->
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="text-center">
                    {% if book.image %}
                        <img src="{{ book.image.url }}" alt="{{ book.title }}" class="book-cover">
                    {% else %}
                        <img src="{% static "images/no-image.jpg" %}" alt="No image" class="book-cover">
                    {% endif %}
                </div>
            </div>

            <!-- Book Details -->
            <div class="col-lg-5 col-md-6 mb-4">
                <h1 class="h2 mb-3">{{ book.title }}</h1>
                
                <div class="mb-3">
                    <span class="text-muted">Автор: </span>
                    {{ book.get_authors }}
                </div>

                <div class="mb-3">
                    <div class="rating-stars mb-1">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <small class="text-muted">(248 відгуків)</small>
                </div>
                
                {% if book.available %}
                    <div class="availability-badge in-stock mb-3">
                        <i class="fas fa-check-circle"></i> В наявності 
                    </div>
                {% else %}
                    <div class="availability-badge mb-3">
                        <i class="fa-solid fa-xmark"></i> Немає в наявності
                    </div>
                {% endif %}

                <div class="book-info-section">
                    <div class="row">
                        <div class="col-6 col-sm-4 mb-2">
                            <small class="text-muted">Видавництво:</small><br>
                            <span>{{ book.publisher }}</span>
                        </div>
                        <div class="col-6 col-sm-4 mb-2">
                            <small class="text-muted">Мова:</small><br>
                            <span>{{ book.language }}</span>
                        </div>
                        <div class="col-6 col-sm-4 mb-2">
                            <small class="text-muted">Обкладинка:</small><br>
                            <span>{{ book.cover }}</span>
                        </div>
                        <div class="col-6 col-sm-4 mb-2">
                            <small class="text-muted">ISBN:</small><br>
                            <span>{{ book.isbn }}</span>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5>Опис книги</h5>
                    <p class="text-muted">
                        {{ book.short_description | safe }}
                    </p>
                </div>
            </div>

            <!-- Purchase Section -->
            <div class="col-lg-3">
                <div class="price-section sticky-top">
                    <div class="mb-3">
                        {% if not book.available %}
                            <span>0 грн</span>
                        {% else %}
                            {% if book.is_discount %}
                                <div class="old-price mb-1">{{ book.price }} грн</div>
                                <div class="new-price">{{ book.get_price_with_discount|floatformat:2 }} грн</div>
                                <small class="text-success"><i class="fas fa-tag"></i> Знижка 20%</small>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <form action="{% url "cart:add" book.id %}" method="POST" id="detail-add-to-cart">
                            {% csrf_token %}
                            <input type="hidden" name="override" value="false">
                            <label class="form-label">Кількість:</label>
                            <div class="input-group cart-input-group mb-3" style="max-width: 145px;">
                                <button class="btn btn-outline-secondary btn-minus" type="button">-</button>
                                <input type="text" name="quantity" class="form-control text-center" value="1" min="1">
                                <button class="btn btn-outline-secondary btn-plus" type="button">+</button>
                            </div>
                            <div class="d-grid gap-2 mb-3">
                                <button class="btn btn-primary-custom btn-lg" type="submit" data-bs-toggle="modal" data-bs-target="#cart-modal">
                                    <i class="fas fa-shopping-cart"></i> Купити
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-undo"></i> Повернення протягом 14 днів
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="row mt-5">
            <div class="col-12">
                <ul class="nav nav-tabs book-tabs" id="bookTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button">
                            Опис
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="characteristics-tab" data-bs-toggle="tab" data-bs-target="#characteristics" type="button">
                            Характеристики
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button id="comment-btn" class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button">
                            Відгуки ({{book.comments.count}})
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-4" id="bookTabsContent">
                    <div class="tab-pane fade show active" id="description" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-8">
                                <h4>Повний опис книги</h4>
                                {{ book.description| safe }}
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="characteristics" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-6">
                                <table class="table table-striped">
                                    <tbody>
                                        <tr><td><strong>ISBN</strong></td><td>{{ book.isbn }}</td></tr>
                                        <tr><td><strong>Автор</strong></td><td>{{ book.get_authors }}</td></tr>
                                        <tr><td><strong>Видавництво</strong></td><td>{{ book.publisher }}</td></tr>
                                        <tr><td><strong>Обкладинка</strong></td><td>{{ book.cover }}</td></tr>
                                        <tr><td><strong>Мова</strong></td><td>{{ book.language }}</td></tr>
                                        {% for characteristic in book.other_characteristics.all %}
                                            <tr><td><strong>{{ characteristic.item.name}}</strong></td><td>{{ characteristic.value }}</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-8">
                                

                                <div class="reviews-holder" data-url-review="{% url "comments:comment_list" book_id=book.id %}"></div>
                                
                                <!-- Форма для додавання відгуку -->
                                <div class="mt-5 pt-4 border-top">
                                    <h5 class="mb-4">Залишити відгук</h5>
                                    {% comment %} {{comment_form}} {% endcomment %}
                                    <form id="reviewForm" class="review-form" action="{% url "comments:comment_create" %}">
                                        <div class="row">
                                            <div class="col mb-3">
                                                <label for="id_name" class="form-label">Ваше ім'я <span class="text-danger">*</span></label>
                                                <input 
                                                type="text" 
                                                name="name"
                                                value="{% if comment_form.name.value %}{{ comment_form.name.value }}{% endif %}"
                                                class="form-control"
                                                id="id_name"
                                                required
                                                >
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Ваша оцінка <span class="text-danger">*</span></label>
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <div  class="star-rating rating-set"> 
                                                        <div class="star-rating__body" data-rating-value="{{comment_form.rating.value}}">
                                                            <div class="star-rating__active"></div>
                
                                                            <div class="star-rating__items">
                                                                {% for k, v in comment_form.rating.field.choices %}
                                                                    <input 
                                                                    type="radio" 
                                                                    name="rating"
                                                                    value={{ v }}
                                                                    class="star-rating__item"
                                                                    {% if comment_form.rating.value == k %}checked{% endif %}
                                                                    >
                                                                {% endfor %}
                                                                {% comment %} <input type="radio" name="rating" value="1" class="star-rating__item">
                                                                <input type="radio" name="rating" value="2" class="star-rating__item">
                                                                <input type="radio" name="rating" value="3" class="star-rating__item">
                                                                <input type="radio" name="rating" value="4" class="star-rating__item">
                                                                <input type="radio" name="rating" value="5" class="star-rating__item"> {% endcomment %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <span class="rating-text text-muted">Оберіть оцінку</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="id_body" class="form-label">Ваш відгук <span class="text-danger">*</span></label>
                                            <textarea class="form-control" name="body" maxlength="{{comment_form.body.field.max_length}}" id="id_body" rows="4" placeholder="Поділіться своїми враженнями про книгу..." required></textarea>
                                            <div class="form-text">Мінімум 10 символів</div>
                                        </div>
                                        <input type="hidden" name="user" id="id_user" value={{ comment_form.user.value }}>
                                        <input type="hidden" name="book" id="id_book" value={{ comment_form.book.value }}>
                                        {% csrf_token %}
                                        
                                        <button type="submit" class="btn btn-primary-custom">
                                            <i class="fas fa-paper-plane"></i> Опублікувати відгук
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}


    {% comment %} {% block scripts %}
        {% include "components/_scripts.html" %}
        <script src="{% static "js/starrating.js" %}"></script>
    {% endblock scripts %} {% endcomment %}

    
